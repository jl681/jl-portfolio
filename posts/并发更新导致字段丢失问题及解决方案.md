---
title: 'å¹¶å‘æ›´æ–°å¯¼è‡´å­—æ®µä¸¢å¤±é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ'
description: 'åˆ†æå¹¶å‘æ›´æ–°å¯¼è‡´å­—æ®µä¸¢å¤±ï¼ˆLost Updateï¼‰çš„é—®é¢˜ï¼Œå¹¶ç»™å‡ºå­—æ®µçº§æ›´æ–°ã€ä¹è§‚é”ã€æ‚²è§‚é”ä¸äº‹ä»¶åˆå¹¶å±‚ç­‰è§£å†³æ–¹æ¡ˆã€‚'
date: '2025-10-31'
category: 'database'
tags:
  - concurrency
  - lost-update
  - jpa
  - kotlin
---

# å¹¶å‘æ›´æ–°å¯¼è‡´å­—æ®µä¸¢å¤±é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

## 1. é—®é¢˜æè¿°

- **Event1**ï¼šæ›´æ–°å­—æ®µ `field1` å’Œ `field2`
- **Event2**ï¼šæ›´æ–°å­—æ®µ `field3`

å½“å‰å¤„ç†é€»è¾‘ï¼š

```kotlin
val entity = repository.findById(id).get()
entity.field1 = newValue1
entity.field2 = newValue2
repository.save(entity)
```

- Event2 å…ˆæ›´æ–° `field3` å¹¶ä¿å­˜ï¼ŒEvent1 åä¿å­˜æ•´è¡Œæ—¶ä¼šè¦†ç›– `field3`ã€‚
- ç»“æœï¼šå­—æ®µ `field3` ä¸¢å¤±ã€‚

---

## 2. å¯èƒ½çš„è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šå­—æ®µçº§æ›´æ–°ï¼ˆå±€éƒ¨æ›´æ–°ï¼‰

- ä¸å†æ•´è¡Œä¿å­˜ï¼Œè€Œæ˜¯ä½¿ç”¨ SQL æˆ– JPA æ›´æ–°è¯­å¥åªæ›´æ–°å¿…è¦å­—æ®µã€‚
- Event1 åªæ›´æ–° `field1` å’Œ `field2`ï¼ŒEvent2 åªæ›´æ–° `field3`ã€‚

**ç¤ºä¾‹ï¼šKotlin + Spring Boot + JPA**

```kotlin
@Repository
interface MyEntityRepository : JpaRepository<MyEntity, Long> {

    @Modifying
    @Query("UPDATE MyEntity e SET e.field1 = :f1, e.field2 = :f2 WHERE e.id = :id")
    fun updateField1And2(@Param("id") id: Long, @Param("f1") f1: String, @Param("f2") f2: String)

    @Modifying
    @Query("UPDATE MyEntity e SET e.field3 = :f3 WHERE e.id = :id")
    fun updateField3(@Param("id") id: Long, @Param("f3") f3: String)
}
```

- å¹¶å‘æ€§èƒ½å¥½ï¼Œä¸åŠ é”
- æ˜“äºå®ç°

- éœ€è¦ä»£ç å±‚æ˜ç¡®åªæ›´æ–°ç‰¹å®šå­—æ®µ

---

### æ–¹æ¡ˆäºŒï¼šä¹è§‚é”ï¼ˆOptimistic Lockï¼‰

- JPA è‡ªåŠ¨åœ¨æ›´æ–°æ—¶æ£€æŸ¥ç‰ˆæœ¬ï¼Œè‹¥ç‰ˆæœ¬ä¸åŒ¹é…æŠ›å‡º `OptimisticLockException`ã€‚
- äº‹åŠ¡å¤±è´¥å¯é€‰æ‹©é‡è¯•æˆ–ä¸¢å¼ƒã€‚

**ç¤ºä¾‹ï¼šKotlin + Spring Boot + JPA**

```kotlin
@Entity
data class MyEntity(
    @Id @GeneratedValue val id: Long? = null,
    var field1: String? = null,
    var field2: String? = null,
    var field3: String? = null,

    @Version
    var version: Long? = null
)
```

**Service å±‚ç¤ºä¾‹ï¼š**

```kotlin
@Transactional
fun handleEvent1(event: Event1) {
    val entity = repository.findById(event.id).orElseThrow()
    entity.field1 = event.field1Value
    entity.field2 = event.field2Value
}
```

- ä¸åŠ æ•°æ®åº“è¡Œé”ï¼Œå‡å°‘é˜»å¡
- ç®€å•å®ç°ï¼Œé€‚åˆå†²çªå°‘çš„åœºæ™¯

- è‹¥å¹¶å‘å†²çªå¤šï¼Œå¯èƒ½é¢‘ç¹é‡è¯•

---

### æ–¹æ¡ˆä¸‰ï¼šæ‚²è§‚é”ï¼ˆPessimistic Lockï¼‰

- åœ¨è¯»å–æ•°æ®æ—¶åŠ è¡Œé”ï¼Œé˜»æ­¢å…¶ä»–äº‹åŠ¡åŒæ—¶ä¿®æ”¹
- Spring Data JPA ä¸­ä½¿ç”¨ `@Lock(LockModeType.PESSIMISTIC_WRITE)` æˆ– SQL `SELECT ... FOR UPDATE`

**ç¤ºä¾‹ï¼š**

```kotlin
@Lock(LockModeType.PESSIMISTIC_WRITE)
@Query("SELECT e FROM MyEntity e WHERE e.id = :id")
fun findByIdForUpdate(@Param("id") id: Long): MyEntity
```

**Service å±‚ç¤ºä¾‹ï¼š**

```kotlin
@Transactional
fun handleEvent1(event: Event1) {
    val entity = repository.findByIdForUpdate(event.id)
    entity.field1 = event.field1Value
    entity.field2 = event.field2Value
}
```

- ä¸¥æ ¼ä¿è¯åŒä¸€è¡Œä¸ä¼šè¢«å¹¶å‘ä¿®æ”¹
- é€‚åˆé«˜å†²çªã€é«˜ä¸€è‡´æ€§éœ€æ±‚åœºæ™¯

- å¯èƒ½å‡ºç°æ­»é”

---

### æ–¹æ¡ˆå››ï¼šäº‹ä»¶åˆå¹¶å±‚ï¼ˆå¯é€‰ï¼‰

- å¯¹äº‹ä»¶è¿›è¡Œç¼“å†²æˆ–èšåˆï¼Œåˆå¹¶å¤šæ¬¡æ›´æ–°åå†å†™å…¥æ•°æ®åº“
- å¯åœ¨å†…å­˜æˆ–æ¶ˆæ¯é˜Ÿåˆ—ä¸­å®ç°

- å¯æ‰¹é‡å¤„ç†äº‹ä»¶
- å‡å°‘æ•°æ®åº“å†²çª

- å¢åŠ å»¶è¿Ÿ

---

## 3. è§£å†³æ–¹æ¡ˆé€‰æ‹©å»ºè®®

| ä¼˜å…ˆçº§ | æ–¹æ¡ˆ                   | é€‚ç”¨åœºæ™¯                                 |
| ------ | ---------------------- | ---------------------------------------- |
| ğŸ¥‡     | å­—æ®µçº§æ›´æ–°ï¼ˆå±€éƒ¨æ›´æ–°ï¼‰ | å¤šäº‹ä»¶æ›´æ–°ä¸åŒå­—æ®µï¼Œå†²çªæ¦‚ç‡ä½ï¼Œç®€å•å®‰å…¨ |
| ğŸ¥ˆ     | ä¹è§‚é”                 | å¹¶å‘ä½è‡³ä¸­ç­‰ã€å¶å°”åŒå­—æ®µå†²çªï¼Œå¯é‡è¯•å†²çª |
| ğŸ¥‰     | æ‚²è§‚é”                 | é«˜å¹¶å‘ã€é«˜å†²çªã€å¿…é¡»ä¸¥æ ¼é¡ºåºæˆ–çŠ¶æ€æœºæ“ä½œ |

---

- å…³é”®åŸåˆ™ï¼š**å°½é‡åªæ›´æ–°å¿…è¦å­—æ®µ** + **å¿…è¦æ—¶ä½¿ç”¨é”ä¿æŠ¤**
- å…·ä½“é€‰æ‹©ï¼š
  - **ä¸åŒå­—æ®µæ›´æ–°** â†’ å±€éƒ¨æ›´æ–° + å¯é€‰ä¹è§‚é”
  - **åŒå­—æ®µå¯èƒ½å†²çª** â†’ ä¹è§‚é”æˆ–æ‚²è§‚é”

---

- æ•°æ®è¿ç§»åŠå…¶ä¼˜å…ˆçº§
- transactional ä¸ºä»€ä¹ˆæ— æ³•ä¿è¯ï¼Ÿ
